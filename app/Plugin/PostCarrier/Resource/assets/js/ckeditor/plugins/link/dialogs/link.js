/*
Copyright (c) 2003-2010, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/

(function(){CKEDITOR.dialog.add('link',function(a){var b=CKEDITOR.plugins.link,c=function(){var D=this.getDialog(),E=D.getContentElement('target','popupFeatures'),F=D.getContentElement('target','linkTargetName'),G=this.getValue();if(!E||!F)return;E=E.getElement();E.hide();F.setValue('');switch(G){case 'frame':F.setLabel(a.lang.link.targetFrameName);F.getElement().show();break;case 'popup':E.show();F.setLabel(a.lang.link.targetPopupName);F.getElement().show();break;default:F.setValue(G);F.getElement().hide();break;}},d=function(){var D=this.getDialog(),E=['urlOptions','anchorOptions','emailOptions'],F=this.getValue(),G=D.definition.getContents('upload'),H=G&&G.hidden;if(F=='url'){if(a.config.linkShowTargetTab)D.showPage('target');if(!H)D.showPage('upload');}else{D.hidePage('target');if(!H)D.hidePage('upload');}for(var I=0;I<E.length;I++){var J=D.getContentElement('info',E[I]);if(!J)continue;J=J.getElement().getParent().getParent();if(E[I]==F+'Options')J.show();else J.hide();}},e=/^javascript:/,f=/^mailto:([^?]+)(?:\?(.+))?$/,g=/subject=([^;?:@&=$,\/]*)/,h=/body=([^;?:@&=$,\/]*)/,i=/^#(.*)$/,j=/^((?:http|https|ftp|news):\/\/)?(.*)$/,k=/^(_(?:self|top|parent|blank))$/,l=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,m=/^javascript:([^(]+)\(([^)]+)\)$/,n=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,o=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,p=a.config.clickCountUrlRegex,q=function(D,E){var F=E&&(E.getAttribute('_cke_saved_href')||E.getAttribute('href'))||'',G,H,I,J,K={};if(G=F.match(e))if(z=='encode')F=F.replace(l,function(ag,ah,ai){return 'mailto:'+String.fromCharCode.apply(String,ah.split(','))+(ai&&x(ai));});else if(z)F.replace(m,function(ag,ah,ai){if(ah==A.name){K.type='email';var aj=K.email={},ak=/[^,\s]+/g,al=/(^')|('$)/g,am=ai.match(ak),an=am.length,ao,ap;for(var aq=0;aq<an;aq++){ap=decodeURIComponent(x(am[aq].replace(al,'')));ao=A.params[aq].toLowerCase();aj[ao]=ap;}aj.address=[aj.name,aj.domain].join('@');}});if(!K.type)if(I=F.match(i)){K.type='anchor';K.anchor={};K.anchor.name=K.anchor.id=I[1];}else if(H=F.match(f)){var L=F.match(g),M=F.match(h);K.type='email';var N=K.email={};N.address=H[1];L&&(N.subject=decodeURIComponent(L[1]));M&&(N.body=decodeURIComponent(M[1]));}else if(F&&(J=F.match(p))){var O='linkUrl'+J[1]+'_id',P=document.getElementById(O),Q=P.value,R='linkValue'+J[1]+'_id',S=document.getElementById(R),T=S.value;urlMatch2=Q.match(j);K.type='url';
K.url={};K.url.protocol=urlMatch2[1];K.url.url=urlMatch2[2];K.url.ccMark=J[0];K.url.ccMarkNo=J[1];K.url.desc=T;}else if(F&&(J=F.match(j))){K.type='url';K.url={};K.url.protocol=J[1];K.url.url=J[2];}else K.type='url';if(E){var U=E.getAttribute('target');K.target={};K.adv={};if(!U){var V=E.getAttribute('_cke_pa_onclick')||E.getAttribute('onclick'),W=V&&V.match(n);if(W){K.target.type='popup';K.target.name=W[1];var X;while(X=o.exec(W[2])){if(X[2]=='yes'||X[2]=='1')K.target[X[1]]=true;else if(isFinite(X[2]))K.target[X[1]]=X[2];}}}else{var Y=U.match(k);if(Y)K.target.type=K.target.name=U;else{K.target.type='frame';K.target.name=U;}}var Z=this,aa=function(ag,ah){var ai=E.getAttribute(ah);if(ai!==null)K.adv[ag]=ai||'';};aa('advId','id');aa('advLangDir','dir');aa('advAccessKey','accessKey');aa('advName','name');aa('advLangCode','lang');aa('advTabIndex','tabindex');aa('advTitle','title');aa('advContentType','type');aa('advCSSClasses','class');aa('advCharset','charset');aa('advStyles','style');}var ab=D.document.getElementsByTag('img'),ac=new CKEDITOR.dom.nodeList(D.document.$.anchors),ad=K.anchors=[];for(var ae=0;ae<ab.count();ae++){var af=ab.getItem(ae);if(af.getAttribute('_cke_realelement')&&af.getAttribute('_cke_real_element_type')=='anchor')ad.push(D.restoreRealElement(af));}for(ae=0;ae<ac.count();ae++)ad.push(ac.getItem(ae));for(ae=0;ae<ad.length;ae++){af=ad[ae];ad[ae]={name:af.getAttribute('name'),id:af.getAttribute('id')};}this._.selectedElement=E;return K;},r=function(D,E){if(E[D])this.setValue(E[D][this.id]||'');},s=function(D){return r.call(this,'target',D);},t=function(D){return r.call(this,'adv',D);},u=function(D,E){if(!E[D])E[D]={};E[D][this.id]=this.getValue()||'';},v=function(D){return u.call(this,'target',D);},w=function(D){return u.call(this,'adv',D);};function x(D){return D.replace(/\\'/g,"'");};function y(D){return D.replace(/'/g,'\\$&');};var z=a.config.emailProtection||'';if(z&&z!='encode'){var A={};z.replace(/^([^(]+)\(([^)]+)\)$/,function(D,E,F){A.name=E;A.params=[];F.replace(/[^,\s]+/g,function(G){A.params.push(G);});});}function B(D){var E,F=A.name,G=A.params,H,I;E=[F,'('];for(var J=0;J<G.length;J++){H=G[J].toLowerCase();I=D[H];J>0&&E.push(',');E.push("'",I?y(encodeURIComponent(D[H])):'',"'");}E.push(')');return E.join('');};function C(D){var E,F=D.length,G=[];for(var H=0;H<F;H++){E=D.charCodeAt(H);G.push(E);}return 'String.fromCharCode('+G.join(',')+')';};return{title:a.lang.link.title,minWidth:350,minHeight:230,contents:[{id:'info',label:a.lang.link.info,title:a.lang.link.info,elements:[{id:'linkType',type:'select',label:a.lang.link.type,items:[['']],onChange:d,setup:function(D){var G=this;
var E=[[a.lang.link.toUrl,'url'],[a.lang.link.toAnchor,'anchor'],[a.lang.link.toEmail,'email']];G.clear();for(var F=0;F<E.length;F++){if(postcarrier_isMobile()&&E[F][1]=='anchor')continue;G.add(E[F][0],E[F][1]);}if(D.type)G.setValue(D.type);else G.setValue('url');},commit:function(D){D.type=this.getValue();}},{type:'vbox',id:'urlOptions',children:[{type:'hbox',children:[{type:'html',id:'clickCountUrl',style:'text-align: center;',html:'<div role="label" tabIndex="-1">リンクNo.</div>',ccMark:'',ccMarkNo:'',setup:function(D){var E=this;if(D.url&&D.url.ccMark){E.ccMark=D.url.ccMark;E.ccMarkNo=D.url.ccMarkNo;E.getElement().setHtml(CKEDITOR.tools.htmlEncode(D.url.ccMark));E.getElement().show();}else{E.ccMark='';E.ccMarkNo='';E.getElement().hide();}}}]},{type:'hbox',widths:['25%','75%'],children:[{id:'protocol',type:'select',label:a.lang.common.protocol,'default':'http://',items:[['http://‎','http://'],['https://‎','https://']],setup:function(D){if(D.url)this.setValue(D.url.protocol||'');},commit:function(D){if(!D.url)D.url={};var E=this.getDialog().getContentElement('info','clickCountUrl');if(E.ccMark)D.url.protocol='';else D.url.protocol=this.getValue();}},{type:'text',id:'url',label:a.lang.common.url,required:true,onLoad:function(){this.allowOnChange=true;},onKeyUp:function(){var I=this;I.allowOnChange=false;var D=I.getDialog().getContentElement('info','protocol'),E=I.getValue(),F=/^(http|https|ftp|news):\/\/(?=.)/gi,G=/^((javascript:)|[#\/\.\?])/gi,H=F.exec(E);if(H){I.setValue(E.substr(H[0].length));D.setValue(H[0].toLowerCase());}else if(G.test(E))D.setValue('');I.allowOnChange=true;},onChange:function(){if(this.allowOnChange)this.onKeyUp();},validate:function(){var D=this.getDialog();if(D.getContentElement('info','linkType')&&D.getValueOf('info','linkType')!='url')return true;if(this.getDialog().fakeObj)return true;var E=CKEDITOR.dialog.validate.notEmpty(a.lang.link.noUrl);return E.apply(this);},setup:function(D){this.allowOnChange=false;if(D.url)this.setValue(D.url.url);this.allowOnChange=true;},commit:function(D){var I=this;I.onChange();if(!D.url)D.url={};var E=I.getDialog().getContentElement('info','clickCountUrl');if(E.ccMark){D.url.url=E.ccMark;var F=I.getDialog().getContentElement('info','protocol'),G='linkUrl'+E.ccMarkNo+'_id',H=document.getElementById(G);H.value=F.getValue()+I.getValue();}else D.url.url=I.getValue();I.allowOnChange=false;}}],setup:function(D){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().show();}},{type:'hbox',children:[{type:'text',id:'clickCountDescription',label:'説明',setup:function(D){if(D.url&&D.url.ccMark){this.setValue(D.url.desc);
this.getElement().show();}else this.getElement().hide();},commit:function(D){var E=this.getDialog().getContentElement('info','clickCountUrl');if(E.ccMark){var F='linkValue'+E.ccMarkNo+'_id',G=document.getElementById(F);G.value=this.getValue();}}}]},{type:'button',id:'browse',hidden:'true',filebrowser:'info:url',label:a.lang.common.browseServer}]},{type:'vbox',id:'anchorOptions',width:260,align:'center',padding:0,children:[{type:'fieldset',id:'selectAnchorText',label:a.lang.link.selectAnchor,setup:function(D){if(D.anchors.length>0)this.getElement().show();else this.getElement().hide();},children:[{type:'hbox',id:'selectAnchor',children:[{type:'select',id:'anchorName','default':'',label:a.lang.link.anchorName,style:'width: 100%;',items:[['']],setup:function(D){var G=this;G.clear();G.add('');for(var E=0;E<D.anchors.length;E++){if(D.anchors[E].name)G.add(D.anchors[E].name);}if(D.anchor)G.setValue(D.anchor.name);var F=G.getDialog().getContentElement('info','linkType');if(F&&F.getValue()=='email')G.focus();},commit:function(D){if(!D.anchor)D.anchor={};D.anchor.name=this.getValue();}},{type:'select',id:'anchorId','default':'',label:a.lang.link.anchorId,style:'width: 100%;',items:[['']],setup:function(D){var F=this;F.clear();F.add('');for(var E=0;E<D.anchors.length;E++){if(D.anchors[E].id)F.add(D.anchors[E].id);}if(D.anchor)F.setValue(D.anchor.id);},commit:function(D){if(!D.anchor)D.anchor={};D.anchor.id=this.getValue();var E=this.getDialog().getContentElement('info','clickCountUrl');if(D.anchor.id&&E.ccMark){postcarrier_deleteLinkInfo(E.ccMarkNo);E.ccMark='';E.ccMarkNo='';}}}],setup:function(D){if(D.anchors.length>0)this.getElement().show();else this.getElement().hide();}}]},{type:'html',id:'noAnchors',style:'text-align: center;',html:'<div role="label" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(a.lang.link.noAnchors)+'</div>',focus:true,setup:function(D){if(postcarrier_isMobile()){this.getElement().hide();return;}if(D.anchors.length<1)this.getElement().show();else this.getElement().hide();}},{type:'html',id:'canNotUseAnchorsInMobileMode',style:'text-align: center;',html:'<div role="label" tabIndex="-1">'+CKEDITOR.tools.htmlEncode('(デコメではアンカーは使用できません)')+'</div>',focus:true,setup:function(D){if(postcarrier_isMobile())this.getElement().show();else this.getElement().hide();}}],setup:function(D){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().hide();}},{type:'vbox',id:'emailOptions',padding:1,children:[{type:'text',id:'emailAddress',label:a.lang.link.emailAddress,required:true,validate:function(){var D=this.getDialog();
if(!D.getContentElement('info','linkType')||D.getValueOf('info','linkType')!='email')return true;var E=CKEDITOR.dialog.validate.notEmpty(a.lang.link.noEmail);return E.apply(this);},setup:function(D){if(D.email)this.setValue(D.email.address);var E=this.getDialog().getContentElement('info','linkType');if(E&&E.getValue()=='email')this.select();},commit:function(D){if(!D.email)D.email={};D.email.address=this.getValue();var E=this.getDialog().getContentElement('info','clickCountUrl');if(D.email.address&&E.ccMark){postcarrier_deleteLinkInfo(E.ccMarkNo);E.ccMark='';E.ccMarkNo='';}}},{type:'text',id:'emailSubject',hidden:true,label:a.lang.link.emailSubject,setup:function(D){if(D.email)this.setValue(D.email.subject);},commit:function(D){if(!D.email)D.email={};D.email.subject=this.getValue();}},{type:'textarea',id:'emailBody',hidden:true,label:a.lang.link.emailBody,rows:3,'default':'',setup:function(D){if(D.email)this.setValue(D.email.body);},commit:function(D){if(!D.email)D.email={};D.email.body=this.getValue();}}],setup:function(D){if(!this.getDialog().getContentElement('info','linkType'))this.getElement().hide();}}]},{id:'target',label:a.lang.link.target,title:a.lang.link.target,elements:[{type:'hbox',widths:['50%','50%'],children:[{type:'select',id:'linkTargetType',label:a.lang.common.target,'default':'notSet',style:'width : 100%;',items:[[a.lang.common.notSet,'notSet'],[a.lang.link.targetFrame,'frame'],[a.lang.link.targetPopup,'popup'],[a.lang.common.targetNew,'_blank'],[a.lang.common.targetTop,'_top'],[a.lang.common.targetSelf,'_self'],[a.lang.common.targetParent,'_parent']],onChange:c,setup:function(D){if(D.target)this.setValue(D.target.type);c.call(this);},commit:function(D){if(!D.target)D.target={};D.target.type=this.getValue();}},{type:'text',id:'linkTargetName',label:a.lang.link.targetFrameName,'default':'',setup:function(D){if(D.target)this.setValue(D.target.name);},commit:function(D){if(!D.target)D.target={};D.target.name=this.getValue().replace(/\W/gi,'');}}]},{type:'vbox',width:260,align:'center',padding:2,id:'popupFeatures',children:[{type:'fieldset',label:a.lang.link.popupFeatures,children:[{type:'hbox',children:[{type:'checkbox',id:'resizable',label:a.lang.link.popupResizable,setup:s,commit:v},{type:'checkbox',id:'status',label:a.lang.link.popupStatusBar,setup:s,commit:v}]},{type:'hbox',children:[{type:'checkbox',id:'location',label:a.lang.link.popupLocationBar,setup:s,commit:v},{type:'checkbox',id:'toolbar',label:a.lang.link.popupToolbar,setup:s,commit:v}]},{type:'hbox',children:[{type:'checkbox',id:'menubar',label:a.lang.link.popupMenuBar,setup:s,commit:v},{type:'checkbox',id:'fullscreen',label:a.lang.link.popupFullScreen,setup:s,commit:v}]},{type:'hbox',children:[{type:'checkbox',id:'scrollbars',label:a.lang.link.popupScrollBars,setup:s,commit:v},{type:'checkbox',id:'dependent',label:a.lang.link.popupDependent,setup:s,commit:v}]},{type:'hbox',children:[{type:'text',widths:['30%','70%'],labelLayout:'horizontal',label:a.lang.link.popupWidth,id:'width',setup:s,commit:v},{type:'text',labelLayout:'horizontal',widths:['55%','45%'],label:a.lang.link.popupLeft,id:'left',setup:s,commit:v}]},{type:'hbox',children:[{type:'text',labelLayout:'horizontal',widths:['30%','70%'],label:a.lang.link.popupHeight,id:'height',setup:s,commit:v},{type:'text',labelLayout:'horizontal',label:a.lang.link.popupTop,widths:['55%','45%'],id:'top',setup:s,commit:v}]}]}]}]},{id:'upload',label:a.lang.link.upload,title:a.lang.link.upload,hidden:true,filebrowser:'uploadButton',elements:[{type:'file',id:'upload',label:a.lang.common.upload,style:'height:40px',size:29},{type:'fileButton',id:'uploadButton',label:a.lang.common.uploadSubmit,filebrowser:'info:url','for':['upload','upload']}]},{id:'advanced',label:a.lang.link.advanced,title:a.lang.link.advanced,elements:[{type:'vbox',padding:1,children:[{type:'hbox',widths:['45%','35%','20%'],children:[{type:'text',id:'advId',label:a.lang.link.id,setup:t,commit:w},{type:'select',id:'advLangDir',label:a.lang.link.langDir,'default':'',style:'width:110px',items:[[a.lang.common.notSet,''],[a.lang.link.langDirLTR,'ltr'],[a.lang.link.langDirRTL,'rtl']],setup:t,commit:w},{type:'text',id:'advAccessKey',width:'80px',label:a.lang.link.acccessKey,maxLength:1,setup:t,commit:w}]},{type:'hbox',widths:['45%','35%','20%'],children:[{type:'text',label:a.lang.link.name,id:'advName',setup:t,commit:w},{type:'text',label:a.lang.link.langCode,id:'advLangCode',width:'110px','default':'',setup:t,commit:w},{type:'text',label:a.lang.link.tabIndex,id:'advTabIndex',width:'80px',maxLength:5,setup:t,commit:w}]}]},{type:'vbox',padding:1,children:[{type:'hbox',widths:['45%','55%'],children:[{type:'text',label:a.lang.link.advisoryTitle,'default':'',id:'advTitle',setup:t,commit:w},{type:'text',label:a.lang.link.advisoryContentType,'default':'',id:'advContentType',setup:t,commit:w}]},{type:'hbox',widths:['45%','55%'],children:[{type:'text',label:a.lang.link.cssClasses,'default':'',id:'advCSSClasses',setup:t,commit:w},{type:'text',label:a.lang.link.charset,'default':'',id:'advCharset',setup:t,commit:w}]},{type:'hbox',children:[{type:'text',label:a.lang.link.styles,'default':'',id:'advStyles',setup:t,commit:w}]}]}]}],onShow:function(){var G=this;
G.fakeObj=false;var D=G.getParentEditor(),E=D.getSelection(),F=null;if((F=b.getSelectedLink(D))&&F.hasAttribute('href'))E.selectElement(F);else if((F=E.getSelectedElement())&&F.is('img')&&F.getAttribute('_cke_real_element_type')&&F.getAttribute('_cke_real_element_type')=='anchor'){G.fakeObj=F;F=D.restoreRealElement(G.fakeObj);E.selectElement(G.fakeObj);}else F=null;G.setupContent(q.apply(G,[D,F]));},onOk:function(){var D={href:'javascript:void(0)/*'+CKEDITOR.tools.getNextNumber()+'*/'},E=[],F={href:D.href},G=this,H=this.getParentEditor();this.commitContent(F);switch(F.type||'url'){case 'url':var I=F.url&&F.url.protocol!=undefined?F.url.protocol:'http://',J=F.url&&F.url.url||'';D._cke_saved_href=J.indexOf('/')===0?J:I+J;break;case 'anchor':var K=F.anchor&&F.anchor.name,L=F.anchor&&F.anchor.id;D._cke_saved_href='#'+(K||L||'');break;case 'email':var M,N=F.email,O=N.address;switch(z){case '':case 'encode':var P=encodeURIComponent(N.subject||''),Q=encodeURIComponent(N.body||''),R=[];P&&R.push('subject='+P);Q&&R.push('body='+Q);R=R.length?'?'+R.join('&'):'';if(z=='encode'){M=["javascript:void(location.href='mailto:'+",C(O)];R&&M.push("+'",y(R),"'");M.push(')');}else M=['mailto:',O,R];break;default:var S=O.split('@',2);N.name=S[0];N.domain=S[1];M=['javascript:',B(N)];}D._cke_saved_href=M.join('');break;}if(F.target)if(F.target.type=='popup'){var T=["window.open(this.href, '",F.target.name||'',"', '"],U=['resizable','status','location','toolbar','menubar','fullscreen','scrollbars','dependent'],V=U.length,W=function(ai){if(F.target[ai])U.push(ai+'='+F.target[ai]);};for(var X=0;X<V;X++)U[X]=U[X]+(F.target[U[X]]?'=yes':'=no');W('width');W('left');W('height');W('top');T.push(U.join(','),"'); return false;");D._cke_pa_onclick=T.join('');}else{if(F.target.type!='notSet'&&F.target.name)D.target=F.target.name;else E.push('target');E.push('_cke_pa_onclick','onclick');}if(F.adv){var Y=function(ai,aj){var ak=F.adv[ai];if(ak)D[aj]=ak;else E.push(aj);};if(this._.selectedElement)Y('advId','id');Y('advLangDir','dir');Y('advAccessKey','accessKey');Y('advName','name');Y('advLangCode','lang');Y('advTabIndex','tabindex');Y('advTitle','title');Y('advContentType','type');Y('advCSSClasses','class');Y('advCharset','charset');Y('advStyles','style');}if(!this._.selectedElement){var Z=H.getSelection(),aa=Z.getRanges(true);if(aa.length==1&&aa[0].collapsed){var ab=new CKEDITOR.dom.text(F.type=='email'?F.email.address:D._cke_saved_href,H.document);aa[0].insertNode(ab);aa[0].selectNodeContents(ab);
Z.selectRanges(aa);}var ac=new CKEDITOR.style({element:'a',attributes:D});ac.type=2;ac.apply(H.document);if(F.adv&&F.adv.advId){var ad=this.getParentEditor().document.$.getElementsByTagName('a');for(X=0;X<ad.length;X++){if(ad[X].href==D.href){ad[X].id=F.adv.advId;break;}}}}else{var ae=this._.selectedElement,af=ae.getAttribute('_cke_saved_href'),ag=ae.getHtml();if(CKEDITOR.env.ie&&D.name!=ae.getAttribute('name')){var ah=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(D.name)+'">',H.document);Z=H.getSelection();ae.moveChildren(ah);ae.copyAttributes(ah,{name:1});ah.replace(ae);ae=ah;Z.selectElement(ae);}ae.setAttributes(D);ae.removeAttributes(E);if(af==ag||F.type=='email'&&ag.indexOf('@')!=-1)ae.setHtml(F.type=='email'?F.email.address:D._cke_saved_href);if(ae.getAttribute('name'))ae.addClass('cke_anchor');else ae.removeClass('cke_anchor');if(this.fakeObj)H.createFakeElement(ae,'cke_anchor','anchor').replace(this.fakeObj);delete this._.selectedElement;}},onLoad:function(){if(!a.config.linkShowAdvancedTab)this.hidePage('advanced');if(!a.config.linkShowTargetTab)this.hidePage('target');},onFocus:function(){var D=this.getContentElement('info','linkType'),E;if(D&&D.getValue()=='url'){E=this.getContentElement('info','url');E.select();}}};});})();
